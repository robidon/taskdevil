<dom-module id="td-menu-user">
  <template>
    <style include="menu-styles">
      :host{
        display: block;
        height: 100%;
      }
      .statusSwitcher {
        position:relative;
        line-height:40px;
        text-align:center;
        background:#fff;
      }
      #filtersDialog {
        padding-bottom: 8px;
        min-width: 300px;
      }
      .filterDialogContent {
        padding:30px;
      }
      .menuTaskItem {
        padding: 4px 0px;
      }
    </style>

    <paper-dialog id="filtersDialog" on-iron-overlay-opened="patchOverlay" role="dialog" class="paper-dialog" with-backdrop always-on-top>
      <div class="filterDialogContent">
        <td-user-select label="Пользователь" value="{{user_id}}" username="{{user_name}}" empty="Все пользователи"></td-user-select>
        <td-project-select label="Проект" value="{{project_id}}" projectname="{{project_name}}" empty="Все проекты"></td-project-select>
      </div>
      <div class="buttons">
        <paper-button on-tap="applyFilters" raised class="custom indigo">Применить</paper-button>
      </div>
    </paper-dialog>


    <paper-scroll-header-panel class="flex height100">

      <div class="paper-header" style="position:relative">

        <div class="tabHeader">
          <paper-input-container on-tap="toggleFilters" style="cursor:pointer">
            <label>Задачи</label>
            <input is="iron-input" value$="[[user_name]], [[project_name]]" disabled style="cursor:pointer"/>
            <iron-icon id="filtersIcon" suffix icon="editor:mode-edit"></iron-icon>
            <paper-ripple></paper-ripple>
          </paper-input-container>
        </div>

        <div class="layout horizontal no-wrap statusSwitcher">
          <paper-icon-button on-tap="prevStatus" icon="hardware:keyboard-arrow-left"></paper-icon-button>
          <div class="flex">[[selectedStatus.name]]</div>
          <paper-icon-button on-tap="nextStatus" icon="hardware:keyboard-arrow-right"></paper-icon-button>
        </div>

      </div>

      <div>
        <td-preloader display="[[showPreloader]]"></td-preloader>
        <template is="dom-if" if="[[!foundTasks.length]]">
          <div class="emptyMessage">Нет таких задач</div>
        </template>
        <paper-listbox multi id="foundTasksList" selected="{{selectedTasks}}">
          <template is="dom-repeat" items="[[foundTasks]]">
            <paper-item>
              <paper-item-body class="menuTaskItem">
                <div><a href="/task-info/[[item.id]]" on-tap="">[[item.subject]]</a></div>
                <div secondary>
                  <td-task-tracker-icon size="16" tracker=[[item.tracker]] priority=[[item.priority]]></td-task-tracker-icon>
                  [[item.project.name]]
                </div>
              </paper-item-body>
            </paper-item>
          </template>
        </paper-listbox>
      </div>

    </paper-scroll-header-panel>

  </template>
  <script type="text/javascript">
    Polymer({
      is:'td-menu-user',
      properties: {
        'user_id':{
          type:Number,
        },
        'user_name':{
          type:String,
        },
        'project_id':{
          type:Number,
        },
        'project_name':{
          type:String,
        },
        'statuses': {
          type:Array,
        },
      },
      ready: function () {
        this.foundTasks = [];
        var T = this;
        this.statuses = [
          3,2,8,1,9
        ];
        for(var i in this.statuses) {
          this.statuses[i] = TD.statuses[this.statuses[i]];
        }
        this.selectedStatusInd = 0;
        this.selectedStatus = this.statuses[this.selectedStatusInd];
        var user = TD.auth.getCurrentUser();
        T.user_id = user.id;
        T.user_name = user.firstname + " " + user.lastname;
        T.filtersChanged();
      },
      nextStatus:function () {
        this.selectedStatusInd = (this.selectedStatusInd + 1) % this.statuses.length;
        this.selectedStatus = this.statuses[this.selectedStatusInd];
        this.filtersChanged();
      },
      prevStatus:function () {
        this.selectedStatusInd = (this.selectedStatusInd + this.statuses.length - 1) % this.statuses.length;
        this.selectedStatus = this.statuses[this.selectedStatusInd];
        this.filtersChanged();
      },
      toggleFilters: function () {
        this.$.filtersDialog.toggle();
      },
      applyFilters: function () {
        this.toggleFilters();
        this.filtersChanged();
      },
      filterTasks: function (item) {
        return item.status.id == this.selectedStatus.id;
      },
      filtersChanged: function () {
        this.foundTasks = [];
        var params = {};
        var T = this;
        T.showPreloader = true;
        params.status_id = [this.selectedStatus.id];
        if (T.project_id) {
          params.project_id = [T.project_id];
        }
        if (T.user_id) {
          params.assigned_to_id = [T.user_id];
        }
        TD.tasks.fetchByFilter(params).then(function (tasks) {
          T.showPreloader = false;
          T.allFoundTasks = tasks;
          T.foundTasks = _.filter(T.allFoundTasks, function (el) {
            return el.status.id == T.selectedStatus.id;
          });
        }).catch(function () {
          T.showPreloader = false;
        });
      },
      patchOverlay: function (e) {
        if (e.target.withBackdrop) {
          try {
            e.target.backdropElement.parentNode.insertBefore(e.target, e.target.backdropElement);
          } catch (exc) {

          }
        }
      }
    })
  </script>
</dom-module>